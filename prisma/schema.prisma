generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                   String           @id @default(uuid())
  firstname            String
  lastname             String
  username             String           @unique
  email                String?          @unique
  emailSubscribed      Boolean?         @default(false)
  password             String
  color                String?
  role                 UserRole         @default(NEW)
  avatarUrl            String?
  resetPasswordExpires DateTime?
  resetPasswordToken   String?          @unique
  claimants            Claimant[]       @relation("UserClaimants")
  comments             Comment[]
  messages             Message[]        @relation("UserMessages")
  starred              StarredMessage[]
  survivorEntries      SurvivorEntry[]
  team                 Team?
  priorYearCaptainStandings PriorYearStanding[] @relation("UserPriorYearCaptainStandings")

  @@unique([firstname, lastname])
}

model Team {
  id             String              @id @default(uuid())
  name           String              @unique
  ownerId        String?             @unique
  wins           Int                 @default(0)
  losses         Int                 @default(0)
  ties           Int                 @default(0)
  points         Int                 @default(0)
  pointsAgainst  Int                 @default(0)
  streak         String              @default("W0")
  playoffSeed    Int?
  completedWeeks Int[]
  allTimeWins    Int                 @default(0)     
  allTimeLosses  Int                 @default(0)    
  allTimeTies    Int                 @default(0)     
  team1Matches   Match[]             @relation("Team1Matches")
  team2Matches   Match[]             @relation("Team2Matches")
  players        Player[]
  transactions   PlayerTransaction[]
  rosters        Roster[]            @relation("TeamRosters")
  owner          User?               @relation(fields: [ownerId], references: [id])
  priorYearStandings PriorYearStanding[] @relation("TeamPriorYearStandings")
  tradesFrom Trade[]     @relation("TradesFromTeam")
  tradesTo   Trade[]     @relation("TradesToTeam")
  tradeVotes TradeVote[] @relation("TeamTradeVotes")
  tradeDrops TradeDrop[] @relation("TradeDropsForTeam")
}

model Player {
  id             String        @id @default(uuid())
  name           String
  league         String
  position       String
  setPosition    String        @default("")
  teamId         String?
  lyAverage      String?
  lyGames        String?
  lyPoints       String?
  
  badges         PlayerBadge[]  
  playerRank     PlayerRank?   @relation("Player_PlayerRank")

  dropClaimants  Claimant[]    @relation("DropPlayer")
  team           Team?         @relation(fields: [teamId], references: [id])
  claims         PlayerClaim[] @relation("PlayerClaims")
  transactions   PlayerTransaction[]
  rosters        Roster[]      @relation("PlayerRosters")
  survivorPicks  SurvivorPlayer[]
  survivorUsages SurvivorUsedPlayer[]
  weekLineups    SurvivorWeekLineup[]
  weekScores     WeekScore[]

  tradePlayers TradePlayer[] @relation("PlayerTradePlayers")
  tradeDrops   TradeDrop[]   @relation("PlayerTradeDrops")

  @@unique([name, league])
}

model PlayerRank {
  id               String  @id @default(uuid())
  playerId         String  @unique
  player           Player  @relation("Player_PlayerRank", fields: [playerId], references: [id])

  avgRank          Int?    @default(0)
  avgPercent       Float?  @default(0.0)

  fanPoints        Int?    @default(0)
  fanPercent       Float?  @default(0.0)

  fanPPG           Int?    @default(0)
  fanPPGPercent    Float?  @default(0.0)   

  seriesRank       Int?    @default(0)
  seriesPercent    Float?  @default(0.0)

  pinfallRank      Int?    @default(0)
  pinfallPercent   Float?  @default(0.0)
}

model Roster {
  id       String @id @default(uuid())
  week     Int
  position String
  playerId String
  teamId   String
  player   Player @relation("PlayerRosters", fields: [playerId], references: [id], onDelete: Cascade)
  team     Team   @relation("TeamRosters", fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([week, playerId])
}

model WeekScore {
  id       Int    @id @default(autoincrement())
  week     Int
  average  Int
  game1    Int?
  game2    Int?
  game3    Int?
  playerId String
  myTeam   String
  opponent String
  lanes    String
  player   Player @relation(fields: [playerId], references: [id])

  @@unique([playerId, week])
}

model PlayerTransaction {
  id         String   @id @default(uuid())
  action     String
  playerId   String?
  playerName String?
  teamId     String
  teamName   String
  timestamp  DateTime @default(now())
  player     Player?  @relation(fields: [playerId], references: [id])
  team       Team     @relation(fields: [teamId], references: [id])
}

model Message {
  id         Int              @id @default(autoincrement())
  title      String
  content    String
  createdAt  DateTime         @default(now())
  authorId   String
  leagueOnly Boolean          @default(false)
  comments   Comment[]
  author     User             @relation("UserMessages", fields: [authorId], references: [id])
  starredBy  StarredMessage[]
}

model Comment {
  id        Int      @id @default(autoincrement())
  content   String
  createdAt DateTime @default(now())
  messageId Int
  authorId  String
  author    User     @relation(fields: [authorId], references: [id])
  message   Message  @relation(fields: [messageId], references: [id])
}

model StarredMessage {
  id        Int      @id @default(autoincrement())
  userId    String
  messageId Int
  createdAt DateTime @default(now())
  message   Message  @relation(fields: [messageId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([userId, messageId])
}

model Match {
  id        String  @id @default(uuid())
  week      Int
  season    Int
  team1Id   String
  team2Id   String
  matchType String?
  team1     Team    @relation("Team1Matches", fields: [team1Id], references: [id])
  team2     Team    @relation("Team2Matches", fields: [team2Id], references: [id])

  @@index([week, season])
}

model WeekLock {
  id        String   @id @default(uuid())
  league    String
  season    Int
  week      Int
  completed String   @default("no")
  lockTime  DateTime

  @@unique([league, season, week])
}

model PlayerClaim {
  id        String     @id @default(uuid())
  playerId  String
  createdAt DateTime   @default(now())
  resolved  Boolean    @default(false)
  expiresAt DateTime
  claimants Claimant[] @relation("ClaimantsOnPlayerClaim")
  player    Player     @relation("PlayerClaims", fields: [playerId], references: [id])
}

model Claimant {
  id           String      @id @default(uuid())
  userId       String
  claimId      String
  dropPlayerId String?
  claim        PlayerClaim @relation("ClaimantsOnPlayerClaim", fields: [claimId], references: [id])
  dropPlayer   Player?     @relation("DropPlayer", fields: [dropPlayerId], references: [id])
  user         User        @relation("UserClaimants", fields: [userId], references: [id])

  @@unique([userId, claimId])
}

model SurvivorEntry {
  id              String               @id @default(uuid())
  userId          String
  league          String
  eliminated      Boolean              @default(false)
  createdAt       DateTime             @default(now())
  teamName        String
  updatedAt       DateTime             @updatedAt
  eliminatedWeek  Int?
  winnerStatus    String?
  user            User                 @relation(fields: [userId], references: [id])
  survivorPlayers SurvivorPlayer[]
  usedPlayers     SurvivorUsedPlayer[]
  weekLineups     SurvivorWeekLineup[]

  @@unique([league, teamName])
  @@unique([userId, league])
}

model SurvivorPlayer {
  id        String        @id @default(uuid())
  entryId   String
  playerId  String
  rank      Int
  createdAt DateTime      @default(now())
  entry     SurvivorEntry @relation(fields: [entryId], references: [id], onDelete: Cascade)
  player    Player        @relation(fields: [playerId], references: [id])

  @@unique([entryId, playerId])
  @@unique([entryId, rank])
}

model SurvivorUsedPlayer {
  id        String        @id @default(uuid())
  entryId   String
  week      Int
  playerId  String
  createdAt DateTime      @default(now())
  entry     SurvivorEntry @relation(fields: [entryId], references: [id], onDelete: Cascade)
  player    Player        @relation(fields: [playerId], references: [id])

  @@unique([entryId, week])
}

model SurvivorWeekLineup {
  id        String        @id @default(uuid())
  entryId   String
  week      Int
  playerId  String
  rank      Int
  createdAt DateTime      @default(now())
  entry     SurvivorEntry @relation(fields: [entryId], references: [id], onDelete: Cascade)
  player    Player        @relation(fields: [playerId], references: [id])

  @@unique([entryId, week, playerId])
}

model PlayerBadge {
  id          String   @id @default(uuid())
  name        String
  rank        String
  description String?
  iconUrl     String?
  year        Int
  playerId    String
  player      Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
}

model BowlingTeam {
  id        String           @id @default(uuid())
  name      String
  league    String
  createdAt DateTime         @default(now())

  rank      BowlingTeamRank? 

  @@unique([name, league], name: "name_league")
}

model BowlingTeamRank {
  id              String        @id @default(uuid())
  teamId          String        @unique
  team            BowlingTeam   @relation(fields: [teamId], references: [id])

  avgRank         Int?          @default(0)
  avgPercent      Float?        @default(0.0)

  fanPoints       Int?          @default(0)
  fanPercent      Float?        @default(0.0)

  fanPPG          Int?          @default(0)
  fanPPGPercent   Float?        @default(0.0)

  seriesRank      Int?          @default(0)
  seriesPercent   Float?        @default(0.0)

  pinfallRank     Int?          @default(0)
  pinfallPercent  Float?        @default(0.0)
}

model PriorYearStanding {
  id             String   @id @default(uuid())
  teamId         String?  
  team           Team?    @relation("TeamPriorYearStandings", fields: [teamId], references: [id])
  year           Int
  teamName       String

  place          Int
  wins           Int
  losses         Int
  ties           Int

  pointsFor      Int
  pointsAgainst  Int
  streak         String?

  captainName    String
  captainUserId  String?  
  captainUser    User?    @relation("UserPriorYearCaptainStandings", fields: [captainUserId], references: [id])
}

enum UserRole {
  SUPERADMIN
  ADMIN
  MANAGER
  MEMBER
  NEW
}

// === Trades ===
model Trade {
  id         String      @id @default(uuid())
  fromTeamId String
  toTeamId   String
  status     TradeStatus @default(PENDING)
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt

  fromTeam Team @relation("TradesFromTeam", fields: [fromTeamId], references: [id])
  toTeam   Team @relation("TradesToTeam",   fields: [toTeamId],   references: [id])

  players TradePlayer[]
  drops   TradeDrop[]
  votes   TradeVote[]

  @@index([fromTeamId])
  @@index([toTeamId])
}

model TradePlayer {
  id       String   @id @default(uuid())
  tradeId  String
  playerId String
  role     TradeRole

  trade  Trade  @relation(fields: [tradeId], references: [id])
  // Explicit relation name to match Player.tradePlayers
  player Player @relation("PlayerTradePlayers", fields: [playerId], references: [id])

  @@unique([tradeId, playerId])
}

model TradeDrop {
  id       String @id @default(uuid())
  tradeId  String
  teamId   String
  playerId String

  trade  Trade  @relation(fields: [tradeId], references: [id])
  // Named relation so Team can reference its drops
  team   Team   @relation("TradeDropsForTeam", fields: [teamId], references: [id])
  // optional explicit name for clarity (not strictly required unless you have multiple Player<->TradeDrop relations)
  player Player @relation("PlayerTradeDrops", fields: [playerId], references: [id])

  @@unique([tradeId, teamId, playerId])
}

model TradeVote {
  id        String   @id @default(uuid())
  tradeId   String
  teamId    String
  approved  Boolean
  createdAt DateTime @default(now())

  trade Trade @relation(fields: [tradeId], references: [id])
  team  Team  @relation("TeamTradeVotes", fields: [teamId], references: [id])

  @@unique([tradeId, teamId])
}

// === Enums ===
enum TradeStatus {
  PENDING
  ACCEPTED
  VIEWED
}

enum TradeRole {
  OFFERED
  REQUESTED
}

